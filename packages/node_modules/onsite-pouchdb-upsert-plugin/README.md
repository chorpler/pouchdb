PouchDB Upsert Plugin
=====

[![Greenkeeper badge](https://badges.greenkeeper.io/pouchdb/upsert.svg)](https://greenkeeper.io/)

[![Build Status](https://travis-ci.org/pouchdb/upsert.svg)](https://travis-ci.org/pouchdb/upsert)


# Note
***This fork has been updated as follows***
- Updated to work with PouchDB 7.0.0+
- Source rewritten in TypeScript
- Support for callbacks has been removed in favor of just returning a Promise, because I hate callbacks
- PhantomJS testing has been replaced with Headless Chromium testing, thanks to the `puppeteer` package

## Bug fixes
- No longer goes into an infinite recursive loop if you try to re-delete a previously-deleted document by upserting the value <code>{ _deleted: true }</code>


Breaking changes
----

* 3.0.0: Now written in TypeScript, and removes callback functionality to force returning a Promise.
* 2.0.0: breaks compatibility with PouchDB <4.0.1, see [#9](https://github.com/pouchdb/upsert/pull/9) for details.

PouchDB Upsert Plugin
------
A tiny plugin for PouchDB that provides two convenience methods:

* `upsert()` - update a document, or insert a new one if it doesn't exist ("upsert"). Will keep retrying (forever) if it gets 409 conflicts.
* `putIfNotExists()` - create a new document if it doesn't exist. Does nothing if it already exists.

So basically, if you're tired of manually dealing with 409s or 404s in your PouchDB code, then this is the plugin for you.

Installation
------

### Browser

Download from the `dist/` folder and include it after `pouchdb.js`:

```html
<script src="pouchdb.js"></script>
<script src="pouchdb.upsert.plugin.js"></script>
```

### Node.js

```
npm install @onsite/pouchdb-upsert-plugin
```

Then attach it to the `PouchDB` object:

```js
var PouchDB = require('pouchdb');
PouchDB.plugin(require('pouchdb-upsert-plugin'));
```

Or if using with TypeScript (with Angular 2+, Ionic 2+, etc.):

```typescript
import PouchDB from 'pouchdb';
import * as PouchDBUpsert from 'pouchdb-upsert-plugin';
PouchDB.plugin(PouchDBUpsert);
```

API
--------

Now in a separate document: [API](docs/API.md)



Building
----
```bash
npm install
npm run build
```


Testing
----

### In Node

This will run the tests in Node using LevelDB:

```bash
npm test
```

You can also check for 100% code coverage using:

```bash
npm run coverage
```


If you have mocha installed globally you can run single test with:
```bash
TEST_DB=local mocha --reporter spec --grep search_phrase
```

The `TEST_DB` environment variable specifies the database that PouchDB should use (see `package.json`).

### Automated browser tests in Headless Chromium (Chrome)

```bash
npm run test-browser
```

### Debugging in the browser

```bash
npm run test-local
```
